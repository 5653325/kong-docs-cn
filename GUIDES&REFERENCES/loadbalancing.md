# 负载均衡

## 简介

Kong为多个后端服务提供了多种负载均衡请求：一种简单的基于DNS的方法，以及一个更加动态的环装负载均衡，它还允许service注册，而无需DNS服务器。

## 基于DNS的负载均衡

使用基于DNS的负载均衡时，后端服务的注册是在Kong之外完成的，而Kong只接收来自DNS服务器的更新。

如果名称解析为多个IP地址，则使用包含主机名（而不是IP地址）的主机定义的每个服service将自动使用基于DNS的负载均衡，前提是主机名未解析为`upstream`名称或名称在的DNS主机文件。

DNS记录`ttl`的设置（生存时间）确定刷新信息的频率。使用`ttl`为0时，将使用自己的DNS查询解析每个请求。显然这会有性能损失，但更新/更改 的延迟将非常低。

### A 记录

一条A记录包含一个或多个IP地址。因此，当主机名解析为A记录时，每个后端服务必须具有自己的IP地址。

由于没有权重`weight`信息，所有条目在负载均衡器中将被视为等权重，并且均衡器将执行直接循环。


### SRV 记录

SRV记录包含其所有IP地址的权重和端口信息。后端服务可以通过IP地址和端口号的唯一组合来识别。因此，单个IP地址可以在不同端口上托管同一服务的多个实例。

由于权重`weight`信息可用，每个条目将在负载均衡器中获得自己的权重，并且它将执行加权循环。

同样，任何给定的端口信息都将被来自DNS服务器的端口信息覆盖。如果服务具有`host=myhost.com`和`port=123`属性，并且`myhost.com`解析为`127.0.0.1:456`的SRV记录，则该请求将代理到`http://127.0.0.1:456/somepath`，因为端口`123`将被`456`覆盖。

### DNS 优先

DNS解析器将按顺序开始解析以下记录类型：

1. 上一次成功解决的类型
2. SRV 记录
3. A 记录
4. CNAME 记录

此项可通过[dns_order配置属性]()进行配置。https://docs.konghq.com/1.1.x/configuration/#dns_order

### DNS注意事项

- 每当刷新DNS记录时，都会生成一个列表以正确处理加权。尽量保持权重为彼此的倍数，以保持算法的性能，例如，17和31的2个权重将导致具有527个条目的结构，而权重16和32（或其最小的相对对应物1和2）将导致仅具有3个条目的结构，尤其是具有非常小（或甚至0）的`ttl`值。
- 在这些情况下，某些名称服务器不返回所有条目（由于UDP数据包大小）（例如Consul返回最多3个），给定的Kong节点将仅使用名称服务器提供的少数上游服务实例。在这种情况下，上游实例池可能会加载不一致，因为由于名称服务器提供的信息有限，Kong节点实际上没有察觉到某些实例。要减轻这种使用，请使用其他名称服务器，使用IP地址而不是名称，或确保使用足够的Kong节点仍然使用所有上游服务。
- 当名称服务器返回`3 name error`时，即对Kong的有效响应。如果这是个意外，请首先验证正在查询的名称正确性，然后再检查您的名称服务器配置。
- 从DNS记录（A或SRV）初始选择IP地址不是随机的。因此，当使用`ttl`为0的记录时，名称服务器应该随机化记录条目。

## 环状负载均衡

使用环状负载均衡时，Kong将处理后端服务的添加和删除，并且不需要DNS更新。Kong将会负责服务注册。可以使用单个HTTP请求添加/删除节点，并立即开始/停止接收流量。

配置环状负载均衡是通过`upstream`和`target`实体完成的。

- `target`：具有后端服务所在的端口号的IP地址或主机名，例如。“192.168.100.12:80”。每个目标都会获得额外的权重`weight`，以指示它获得的相对负载。IP地址可以是IPv4和IPv6格式。
- `upstream`：一个'虚拟主机名'，可以在`route`主机字段中使用，例如，名为`weather.v2.service`的上游将获得来自具有`host=weather.v2.service`的服务的所有请求。

### 上游 Upstream

### 目标 Target

### 负载均衡算法

### 负载均衡注意事项



















